generator client {
  provider = "prisma-client-js"
  engineType = "library"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  CUSTOMER
  ADMIN
}

enum DiscountType {
  PERCENTAGE
  FIXED
}

enum OrderStatus {
  PENDING
  PAID
  SHIPPED
  COMPLETED
  CANCELED
}

enum PaymentMethod {
  COD
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
}

model SiteSettings {
  id              String   @id @default("singleton")
  siteName        String   @default("Ecom")
  siteDescription String   @default("Modern e-commerce store")
  logoUrl         String?
  logoPublicId    String?
  logoHeightPx    Int      @default(40)
  primaryColor    String   @default("#111827")
  accentColor     String   @default("#2563eb")
  shippingCents   Int      @default(0)
  discountPercent Int      @default(0)

  fireEnabled     Boolean  @default(true)
  fireIntensity   Int      @default(60)
  
  // Hero Section
  heroHeadline    String   @default("Achetez")
  heroHeadline2   String   @default("des essentiels modernes avec livraison rapide.")
  heroSubtitle    String   @default("Découvrez les produits en vedette, gérez votre panier et passez commande en paiement à la livraison.")
  heroHeadlineColor String?
  heroHeadlineColor1 String?
  heroHeadlineColor2 String?

  updatedAt       DateTime @updatedAt
}

model User {
  id           String         @id @default(cuid())
  name         String
  email        String         @unique
  passwordHash String
  role         Role           @default(CUSTOMER)
  isBlocked    Boolean        @default(false)
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  cart          Cart?
  orders        Order[]
  refreshTokens RefreshToken[]
}

model RefreshToken {
  id        String    @id @default(cuid())
  userId    String
  tokenHash String    @unique
  expiresAt DateTime
  revokedAt DateTime?
  createdAt DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Category {
  id        String    @id @default(cuid())
  name      String    @unique
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  products Product[]
}

model Product {
  id          String    @id @default(cuid())
  name        String
  slug        String    @unique
  description String
  priceCents  Int
  stock       Int
  isActive    Boolean   @default(true)
  discountValue Int?
  discountType  DiscountType?
  shippingCents Int?
  images      Json      @default("[]")
  categoryId  String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  category   Category   @relation(fields: [categoryId], references: [id], onDelete: Restrict)
  cartItems  CartItem[]
  orderItems OrderItem[]

  @@index([categoryId])
  @@index([priceCents])
}

model Cart {
  id        String    @id @default(cuid())
  userId    String    @unique
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  user  User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  items CartItem[]
}

model CartItem {
  id        String   @id @default(cuid())
  cartId    String
  productId String
  quantity  Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  cart    Cart    @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Restrict)

  @@unique([cartId, productId])
  @@index([productId])
}

model Order {
  id            String       @id @default(cuid())
  userId        String?
  status        OrderStatus  @default(PENDING)
  currency      String       @default("DT")
  subtotalCents Int
  discountCents Int          @default(0)
  shippingCents Int          @default(0)
  totalCents    Int
  shipping      Json
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  user    User?       @relation(fields: [userId], references: [id], onDelete: Restrict)
  items   OrderItem[]
  payment Payment?

  @@index([userId])
  @@index([status])
}

model OrderItem {
  id             String   @id @default(cuid())
  orderId        String
  productId      String?
  name           String
  unitPriceCents Int
  quantity       Int
  lineTotalCents Int

  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product? @relation(fields: [productId], references: [id], onDelete: SetNull)

  @@index([orderId])
  @@index([productId])
}

model Payment {
  id          String        @id @default(cuid())
  orderId     String        @unique
  method      PaymentMethod @default(COD)
  status      PaymentStatus @default(PENDING)
  amountCents Int
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
}
